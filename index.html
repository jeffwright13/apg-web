<!doctype html>
<html lang="en" data-theme="auto">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audio Program Generator</title>
    <meta
      name="description"
      content="Generate spoken audio programs from text with optional background music"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
    />
    <link rel="stylesheet" href="styles/custom.css" />
    
    <!-- MP3 Encoder Library (lamejs) -->
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
    
    <!-- Offline Notice Styling (inline to work without CDN) -->
    <style>
      .offline-notice {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: #ff6b6b;
        color: white;
        padding: 1rem;
        text-align: center;
        z-index: 9999;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      }
      .offline-notice.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <!-- Offline Notice Banner -->
    <div id="offline-notice" class="offline-notice">
      ‚ö†Ô∏è <strong>No Internet Connection:</strong> Some features may not work properly. Please connect to the internet and reload the page.
    </div>
    
    <main class="container">
      <header>
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
          <div style="flex: 1;">
            <h1 style="margin-bottom: 0.5rem;">Audio Program Generator</h1>
            <p style="margin-bottom: 0;">
              Create spoken audio programs from text with optional background music
            </p>
          </div>
          
          <!-- Theme Switcher -->
          <div id="theme-switcher" style="display: flex; gap: 0.5rem; align-items: center; padding-top: 0.25rem;">
            <small style="opacity: 0.7; white-space: nowrap;">Theme:</small>
            <select id="theme-select" style="width: auto; padding: 0.25rem 0.5rem; font-size: 0.875rem; margin: 0;" aria-label="Theme selector">
              <option value="auto">Auto</option>
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
          </div>
        </div>
      </header>

      <section id="input-section">
        <article>
          <header><h2>Input</h2></header>

          <form id="apg-form">
            <!-- Phrase File -->
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.5rem;">
              <label for="phrase-file" style="margin-bottom: 0;">
                Phrase File
              </label>
              <small>Text file with phrases and pauses (required)</small>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: stretch">
              <input
                type="file"
                id="phrase-file"
                name="phrase-file"
                accept=".txt"
                style="flex: 1"
              />
              <button
                type="button"
                id="clear-phrase-btn"
                class="secondary"
                style="flex: 0 0 auto; height: auto;"
                title="Clear phrase file"
              >
                Clear
              </button>
            </div>

            <!-- Background Sound -->
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.5rem;">
              <label for="sound-file" style="margin-bottom: 0;">
                Background Sound
              </label>
              <small id="sound-file-help">Optional audio file (MP3, WAV, OGG, M4A, etc.)</small>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: stretch">
              <input
                type="file"
                id="sound-file"
                name="sound-file"
                accept=".wav,.mp3,.ogg,.m4a,.aac,.flac,.aiff,.aif,.webm,audio/*"
                style="flex: 1"
              />
              <button
                type="button"
                id="clear-sound-btn"
                class="secondary"
                style="flex: 0 0 auto; height: auto;"
                title="Clear background sound file"
              >
                Clear
              </button>
            </div>

            <!-- TTS Engine Selection -->
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.5rem;">
              <label for="tts-engine" style="margin-bottom: 0;">
                Text-to-Speech Engine
              </label>
              <small>Which voice generation service to use</small>
            </div>
            <select id="tts-engine" name="tts-engine">
                <option value="openai">
                  OpenAI TTS (pay-as-you-go - $15/1M chars)
                </option>
                <option value="google-cloud">
                  Google Cloud TTS (free tier - recommended)
                </option>
                <option value="web-speech">
                  Web Speech API (free - playback only, browser-dependent)
                </option>
              </select>

            <!-- Browser Warning (Web Speech API) -->
            <div id="browser-warning" style="display: none; margin-top: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: var(--card-background-color); border-left: 3px solid var(--del-color); border-radius: 0.25rem;">
              <small style="color: var(--muted-color); line-height: 1.8;">
                ‚ìò <strong>Limitations:</strong> Web Speech API plays directly through your speakers and doesn't support audio export or background mixing.
                <br /><br />
                ‚ìò <strong style="color: var(--del-color);">Browser Compatibility:</strong> Audio quality varies significantly by browser. <strong>Chrome</strong> and <strong>Edge</strong> provide the best results. Firefox and Safari may produce poor quality audio.
                <br /><br />
                üí° <strong>Recommendation:</strong> For consistent, high-quality audio across all browsers with export and mixing support, use <strong>OpenAI TTS</strong> or <strong>Google Cloud TTS</strong>.
              </small>
            </div>

            <!-- ========== ENGINE-SPECIFIC SETTINGS ========== -->

            <!-- OpenAI TTS Settings -->
            <div id="openai-settings" style="display: none">
              <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.5rem;">
                <label for="openai-api-key" style="margin-bottom: 0;">
                  OpenAI API Key
                </label>
                <small>
                  <a
                    href="https://platform.openai.com/api-keys"
                    target="_blank"
                    >Get API Key</a
                  >
                </small>
              </div>
              <div style="display: flex; gap: 0.5rem">
                <input
                  type="password"
                  id="openai-api-key"
                  name="openai-api-key"
                  placeholder="Enter your OpenAI API key (stored locally in browser)"
                  style="flex: 1"
                />
                <button
                  type="button"
                  id="save-openai-key-btn"
                  class="secondary"
                  style="flex: 0 0 auto"
                >
                  Save
                </button>
              </div>

              <label for="openai-voice">
                Voice
                <select id="openai-voice" name="openai-voice">
                  <option value="nova">Nova (Female - warm and friendly)</option>
                  <option value="shimmer">Shimmer (Female - soft and gentle)</option>
                  <option value="alloy">Alloy (Neutral - balanced)</option>
                  <option value="echo">Echo (Male)</option>
                  <option value="fable">Fable (Male - British)</option>
                  <option value="onyx">Onyx (Male - deep)</option>
                </select>
              </label>

              <details>
                <summary>Advanced TTS Settings</summary>

                <label for="openai-model">
                  Model Quality
                  <select id="openai-model" name="openai-model">
                    <option value="tts-1">Standard ($15/1M chars)</option>
                    <option value="tts-1-hd">HD Quality ($30/1M chars)</option>
                  </select>
                </label>

                <label for="openai-speed">
                  Speed: <span id="openai-speed-value">1.0</span>
                  <input
                    type="range"
                    id="openai-speed"
                    name="openai-speed"
                    min="0.25"
                    max="4.0"
                    step="0.25"
                    value="1.0"
                  />
                </label>
              </details>
            </div>

            <!-- Google Cloud TTS Settings -->
            <div id="google-cloud-settings" style="display: none">
              <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.5rem;">
                <label for="google-api-key" style="margin-bottom: 0;">
                  Google Cloud API Key
                </label>
                <small>
                  <a
                    href="https://console.cloud.google.com/apis/credentials"
                    target="_blank"
                    >Get API Key</a
                  >
                </small>
              </div>
              <div style="display: flex; gap: 0.5rem">
                <input
                  type="password"
                  id="google-api-key"
                  name="google-api-key"
                  placeholder="Enter your Google Cloud API key (stored locally in browser)"
                  style="flex: 1"
                />
                <button
                  type="button"
                  id="save-api-key-btn"
                  class="secondary"
                  style="flex: 0 0 auto"
                >
                  Save
                </button>
              </div>

              <label for="google-voice">
                Voice
                <select id="google-voice" name="google-voice">
                  <option value="en-US-Neural2-C">
                    en-US-Neural2-C (Female)
                  </option>
                  <option value="en-US-Neural2-A">en-US-Neural2-A (Male)</option>
                  <option value="en-US-Neural2-D">en-US-Neural2-D (Male)</option>
                  <option value="en-US-Neural2-E">
                    en-US-Neural2-E (Female)
                  </option>
                </select>
              </label>

              <details>
                <summary>Advanced TTS Settings</summary>

                <label for="speaking-rate">
                  Speaking Rate: <span id="speaking-rate-value">1.0</span>
                  <input
                    type="range"
                    id="speaking-rate"
                    name="speaking-rate"
                    min="0.25"
                    max="4.0"
                    step="0.25"
                    value="1.0"
                  />
                </label>

                <label for="pitch">
                  Pitch: <span id="pitch-value">0.0</span>
                  <input
                    type="range"
                    id="pitch"
                    name="pitch"
                    min="-20"
                    max="20"
                    step="1"
                    value="0"
                  />
                </label>

                <label for="volume-gain">
                  Volume Gain (dB): <span id="volume-gain-value">0.0</span>
                  <input
                    type="range"
                    id="volume-gain"
                    name="volume-gain"
                    min="-96"
                    max="16"
                    step="1"
                    value="0"
                  />
                </label>
              </details>
            </div>

            <!-- Web Speech API Settings -->
            <div id="web-speech-settings" style="display: none">
              <label for="web-speech-voice">
                Voice
                <select id="web-speech-voice" name="web-speech-voice">
                  <option value="">Loading voices...</option>
                </select>
              </label>

              <details>
                <summary>Advanced TTS Settings</summary>

                <label for="web-speech-rate">
                  Speaking Rate: <span id="web-speech-rate-value">1.0</span>
                  <input
                    type="range"
                    id="web-speech-rate"
                    name="web-speech-rate"
                    min="0.5"
                    max="2.0"
                    step="0.1"
                    value="1.0"
                  />
                </label>

                <label for="web-speech-pitch">
                  Pitch: <span id="web-speech-pitch-value">1.0</span>
                  <input
                    type="range"
                    id="web-speech-pitch"
                    name="web-speech-pitch"
                    min="0.5"
                    max="2.0"
                    step="0.1"
                    value="1.0"
                  />
                </label>

                <label for="web-speech-volume">
                  Volume: <span id="web-speech-volume-value">1.0</span>
                  <input
                    type="range"
                    id="web-speech-volume"
                    name="web-speech-volume"
                    min="0"
                    max="1.0"
                    step="0.1"
                    value="1.0"
                  />
                </label>
              </details>
            </div>

            <!-- gTTS Settings -->
            <div id="gtts-settings" style="display: none">
              <label for="gtts-accent">
                Accent/Region
                <select id="gtts-accent" name="gtts-accent">
                  <option value="com">United States</option>
                  <option value="co.uk">United Kingdom</option>
                  <option value="com.au">Australia</option>
                  <option value="ca">Canada</option>
                  <option value="co.in">India</option>
                  <option value="ie">Ireland</option>
                  <option value="co.za">South Africa</option>
                </select>
              </label>

              <details>
                <summary>Advanced TTS Settings</summary>

                <label>
                  <input type="checkbox" id="gtts-slow-speech" name="gtts-slow-speech" />
                  Slow speech (half speed)
                </label>
              </details>
            </div>

            <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--muted-border-color);" />

            <!-- ========== AUDIO MIXING SETTINGS ========== -->
            <details id="audio-mixing-settings">
              <summary>Audio Mixing Settings</summary>
              <small style="color: var(--muted-color); display: block; margin-bottom: 1rem;">
                Post-processing settings for combining speech with background music
              </small>

              <label for="attenuation">
                Background volume adjustment (dB)
                <input
                  type="number"
                  id="attenuation"
                  name="attenuation"
                  value="-6"
                  min="-40"
                  max="6"
                  step="1"
                />
                <small style="color: var(--muted-color);">
                  Negative = quieter, Positive = louder. Try -12 (quarter volume), -6 (half), 0 (same as speech), +3 (1.4x louder)
                </small>
              </label>

              <label for="fade-in">
                Fade in (ms)
                <input
                  type="number"
                  id="fade-in"
                  name="fade-in"
                  value="3000"
                  min="0"
                  max="10000"
                  step="100"
                />
                <small style="color: var(--muted-color);">
                  Duration of fade-in effect at the start
                </small>
              </label>

              <label for="fade-out">
                Fade out (ms)
                <input
                  type="number"
                  id="fade-out"
                  name="fade-out"
                  value="6000"
                  min="0"
                  max="10000"
                  step="100"
                />
                <small style="color: var(--muted-color);">
                  Duration of fade-out effect at the end
                </small>
              </label>
            </details>

          </form>
        </article>
      </section>

      <section id="output-section">
        <article>
          <header><h2>Output</h2></header>
          <div style="display: flex; gap: 0.5rem; align-items: stretch;">
            <button type="submit" form="apg-form" id="generate-btn" style="flex: 1;">
              Generate Audio
            </button>
            <button 
              type="button"
              id="clear-cache-btn" 
              class="secondary" 
              style="flex: 0 0 auto;"
              title="Clear cached TTS audio"
            >
              üóëÔ∏è Clear Cache
            </button>
          </div>

          <!-- Progress -->
          <div id="progress-container" style="display: none">
            <progress id="progress-bar" value="0" max="100"></progress>
            <p id="progress-text" style="text-align: center; margin-top: 0.5rem">
              Initializing...
            </p>
          </div>

          <!-- Playback Controls (Web Speech API) -->
          <div id="playback-controls" style="display: none">
            <div
              style="
                display: flex;
                gap: 1rem;
                justify-content: center;
                margin-top: 1rem;
              "
            >
              <button id="play-btn">‚ñ∂ Play Audio</button>
              <button id="stop-btn" class="secondary">‚èπ Stop</button>
            </div>
          </div>

          <!-- Download Controls (Premium TTS) -->
          <div id="download-controls" style="display: none">
            <audio id="audio-player" controls style="margin-top: 1rem"></audio>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
              <div>
                <label for="export-format">
                  Export Format
                  <select id="export-format" name="export-format">
                    <option value="wav">WAV (uncompressed, large file)</option>
                    <option value="mp3" selected>MP3 (compressed, smaller file)</option>
                  </select>
                </label>
              </div>
              
              <div id="mp3-bitrate-container">
                <label for="mp3-bitrate">
                  MP3 Quality
                  <select id="mp3-bitrate" name="mp3-bitrate">
                    <option value="128">128 kbps (Good, ~1 MB/min)</option>
                    <option value="192" selected>192 kbps (Very Good, ~1.4 MB/min)</option>
                    <option value="256">256 kbps (Excellent, ~1.9 MB/min)</option>
                    <option value="320">320 kbps (Best, ~2.4 MB/min)</option>
                  </select>
                </label>
              </div>
            </div>
            
            <button id="download-btn">Download Audio</button>
          </div>
        </article>
      </section>

      <footer>
        <small
          >Audio Program Generator v0.9.0 | Created by Jeff Wright |
          <a href="https://github.com/jeffwright13/apg-web">GitHub</a></small
        >
      </footer>
    </main>

    <!-- Offline Detection Script (runs before main.js) -->
    <script>
      // Check if CSS loaded properly (Pico CSS sets a specific style)
      window.addEventListener('DOMContentLoaded', () => {
        const offlineNotice = document.getElementById('offline-notice');
        
        function checkResources() {
          // Simple check: if body doesn't have Pico's styling, CSS didn't load
          const bodyStyles = window.getComputedStyle(document.body);
          const hasProperStyling = bodyStyles.fontFamily.includes('system-ui') || 
                                   bodyStyles.fontFamily.includes('Segoe UI');
          
          // Also check if lamejs loaded
          const hasLamejs = typeof lamejs !== 'undefined';
          
          if (!hasProperStyling || !hasLamejs) {
            offlineNotice.classList.add('show');
          } else {
            offlineNotice.classList.remove('show');
          }
        }
        
        // Check on load
        checkResources();
        
        // Listen for network status changes
        window.addEventListener('online', () => {
          // Network restored - suggest reload
          offlineNotice.innerHTML = '‚úÖ <strong>Internet Restored:</strong> Please reload the page to restore full functionality. <button onclick="location.reload()" style="margin-left: 1rem; padding: 0.25rem 0.75rem; background: white; color: #ff6b6b; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Reload Now</button>';
          offlineNotice.style.background = '#51cf66';
        });
        
        window.addEventListener('offline', () => {
          // Network lost
          offlineNotice.innerHTML = '‚ö†Ô∏è <strong>No Internet Connection:</strong> Some features may not work properly. Please connect to the internet and reload the page.';
          offlineNotice.style.background = '#ff6b6b';
          offlineNotice.classList.add('show');
        });
      });
    </script>

    <script type="module" src="scripts/main.js"></script>
  </body>
</html>
